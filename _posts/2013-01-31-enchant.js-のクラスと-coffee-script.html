---
layout: post
title: enchant.js のクラスと coffee-script
date: 2013-01-31 23:52:35 UTC
updated: 2013-01-31 23:52:35 UTC
comments: false
categories: blog
tags: JavaScript CoffeeScript enchant.js
---

<p>最近また coffee-script を使ってるんだけど、やっぱ生の js で十分な気がしてきてる。</p><p>enchant.js を coffee-script で使うとき、以下の様に Sprite を coffee-script 的クラスとして extends できる。</p><table class="syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>1<br />2<br />3<br />4<br />5<br />6<br />7</pre></div></td><td class="code"><div class="syntax"><pre><span class="k">class</span> <span class="nc">Enemy</span> <span class="n">extends</span> <span class="no">Sprite</span><br />  <span class="ss">constructor</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span> <span class="o">-&gt;</span><br />    <span class="k">super</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span><br />    <span class="vi">@x</span> <span class="o">=</span> <span class="n">x</span><br />    <span class="vi">@y</span> <span class="o">=</span> <span class="n">y</span><br />    <span class="vi">@frame</span> <span class="o">=</span> <span class="n">frame</span><br />    <span class="vi">@image</span> <span class="o">=</span> <span class="n">game</span><span class="o">.</span><span class="n">assets</span><span class="o">[</span><span class="s2">&quot;img/enemy.png&quot;</span><span class="o">]</span><br /></pre></div></td></tr></table> <p>いい具合にクラス定義してるんだろうなと思っておわっても良かったんだけど、ちょっと気になったので<a href="https://github.com/wise9/enchant.js/blob/master/dev/src/Class.js">クラス定義</a>を覗いてみた。</p><table class="syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12<br />13<br />14</pre></div></td><td class="code"><div class="syntax"><pre>    <span class="kd">var</span> <span class="nx">Constructor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><br />        <span class="k">if</span> <span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Constructor</span><span class="p">)</span> <span class="p">{</span><br />            <span class="nx">Constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span><br />        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span><br />            <span class="k">return</span> <span class="k">new</span> <span class="nx">Constructor</span><span class="p">();</span><br />        <span class="p">}</span><br />    <span class="p">};</span><br />    <span class="nx">Constructor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">superclass</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">definition</span><span class="p">);</span><br />    <span class="nx">Constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">Constructor</span><span class="p">;</span><br />    <span class="k">if</span> <span class="p">(</span><span class="nx">Constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span><br />        <span class="nx">Constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><br />            <span class="nx">superclass</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span><br />        <span class="p">};</span><br />    <span class="p">}</span><br /></pre></div></td></tr></table> <p>一部を抜粋するけど、ここで Constructor を定義していて、それは initialize でも constructor でも呼べるようになっている。</p><p>ここで、上記の coffee を js に変換したあとのコードをみてみると</p><table class="syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18<br />19<br />20<br />21</pre></div></td><td class="code"><div class="syntax"><pre>  <span class="kd">var</span> <span class="nx">Enemy</span><span class="p">,</span> <span class="nx">game</span><span class="p">,</span><br />    <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span><br />    <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">};</span><br /><br />  <span class="c1">// 中略</span><br /><br />  <span class="nx">Enemy</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span><br /><br />    <span class="nx">__extends</span><span class="p">(</span><span class="nx">Enemy</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span><br /><br />    <span class="kd">function</span> <span class="nx">Enemy</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">frame</span><span class="p">)</span> <span class="p">{</span><br />      <span class="nx">Enemy</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span><br />      <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span><br />      <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">y</span><span class="p">;</span><br />      <span class="k">this</span><span class="p">.</span><span class="nx">frame</span> <span class="o">=</span> <span class="nx">frame</span><span class="p">;</span><br />      <span class="k">this</span><span class="p">.</span><span class="nx">image</span> <span class="o">=</span> <span class="nx">game</span><span class="p">.</span><span class="nx">assets</span><span class="p">[</span><span class="s2">&quot;img/enemy.png&quot;</span><span class="p">];</span><br />    <span class="p">}</span><br /><br />    <span class="k">return</span> <span class="nx">Enemy</span><span class="p">;</span><br /><br />  <span class="p">})(</span><span class="nx">Sprite</span><span class="p">);</span><br /></pre></div></td></tr></table> <p>こんな感じ。なるほど、super の constructor を呼び出してる。__extends は js 的定番コードだし、うまく噛み合うわけだ。</p><h2>注意点</h2><table class="syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>1<br />2<br />3<br />4<br />5</pre></div></td><td class="code"><div class="syntax"><pre><span class="k">class</span> <span class="nc">Enemy</span> <span class="n">extends</span> <span class="no">Sprite</span><br />  <span class="ss">constructor</span><span class="p">:</span> <span class="p">(</span><span class="vi">@x</span><span class="p">,</span> <span class="vi">@y</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span> <span class="o">-&gt;</span><br />    <span class="k">super</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span><br />    <span class="vi">@frame</span> <span class="o">=</span> <span class="n">frame</span><br />    <span class="vi">@image</span> <span class="o">=</span> <span class="n">game</span><span class="o">.</span><span class="n">assets</span><span class="o">[</span><span class="s2">&quot;img/enemy.png&quot;</span><span class="o">]</span><br /></pre></div></td></tr></table> <p>こう書くと、</p><table class="syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>1<br />2<br />3<br />4<br />5<br />6<br />7</pre></div></td><td class="code"><div class="syntax"><pre>    <span class="kd">function</span> <span class="nx">Enemy</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">frame</span><span class="p">)</span> <span class="p">{</span><br />      <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span><br />      <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">y</span><span class="p">;</span><br />      <span class="nx">Enemy</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span><br />      <span class="k">this</span><span class="p">.</span><span class="nx">frame</span> <span class="o">=</span> <span class="nx">frame</span><span class="p">;</span><br />      <span class="k">this</span><span class="p">.</span><span class="nx">image</span> <span class="o">=</span> <span class="nx">game</span><span class="p">.</span><span class="nx">assets</span><span class="p">[</span><span class="s2">&quot;img/enemy.png&quot;</span><span class="p">];</span><br />    <span class="p">}</span><br /></pre></div></td></tr></table> <p>こうなっちゃうので、super が呼ばれる前に x, y がフィールド値に入ってしまい、反映されない。</p><p>coffee 使うときは、このあたりの js 変換ルールを頭に入れておかないと妙なハマリを生むなぁ。今のところ、スコープで結構混乱する。</p>