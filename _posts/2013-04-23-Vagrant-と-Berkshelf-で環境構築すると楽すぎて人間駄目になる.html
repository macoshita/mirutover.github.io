---
layout: post
title: Vagrant と Berkshelf で環境構築すると楽すぎて人間駄目になる
date: 2013-04-23 10:11:14 UTC
updated: 2013-04-23 10:11:14 UTC
comments: false
categories: blog
tags: Berkshelf Vagrant Node
---

<p>エンジニアの歴史はいかに楽をするかの歴史。ということで、Vagrant だけでもう十分楽してた私が、Berkshelf を使ってさらに楽をして駄目人間を目指す話。</p><h2>前提</h2><p>Vagrant を使って VM を立てるまでは確認してあるほうが良い。<a href="http://www.vagrantup.com/">Vagrant</a> の Getting Start くらいは通してあるとよさげ。</p><h3>用語</h3><ul><li><a href="https://www.virtualbox.org/">VirtualBox</a><ul><li>有名な仮想環境構築ツール。</li><li>windows だと<a href="http://mirutover.blogspot.jp/2013/04/vagrant-ssh-windows-ssh-teraterm.html">何かとハマる</a>ので、mac オススメ。でも、苦労はしたけど Windows 7 ではうまく動いた。</li></ul></li><li><a href="http://www.vagrantup.com/">Vagrant</a><ul><li>virtualbox の CLI 型ツール。他の仮想環境にも対応してるけど未確認。EC2 だけちらっと試した（仮想じゃないけど）。</li></ul></li><li><a href="http://berkshelf.com/">Berkshelf</a><ul><li>Chef のクックブックを bundler みたいに管理できるツール</li><li>Chef についてはググろう。でも今回はそこまで詳しくなくて OK。</li></ul></li></ul><h2>各種インストール</h2><ul><li>VirtualBox は普通に最新版をインストール。</li><li>Vagrant もパッケージをダウンロードしてインストールする。昔は gem だったけど、今は公式もこの方法が推奨。</li><li>vagrant のプラグインをインストールする<ul><li>手前味噌だけど<a href="http://mirutover.blogspot.jp/2013/04/windows-vagrant-plugin.html">こちらのエントリ</a>を読んで準備 <code>bash vagrant plugin install vagrant-berkshelf</code></li><li>ハマったのがこれ。タイミングが悪すぎたんだけど、<strong>vagrant-berkshelf にリネームしてる。</strong>ほんの一週間前くらいに README が更新されててムキー。</li></ul></li></ul><p>berkshelf 自体はとりあえず不要なので、ruby 入ってない人は入れなくても OK。berks cookbook myvagrant とかするとひな形作られるから楽っちゃ楽なんだけど、ファイルが大量にできるので、私の場合は最初シンプルにってことでそれを全捨てした。</p><h2>各種設定ファイルの準備</h2><p>適当に myvagrant とかディレクトリを作っておく。</p><p>その中に下記の２つのファイルを設置。今回は、nodejs を入れる設定で試してみる。</p><ul><li>Vagrantfile</li><li>Berksfile</li></ul><h3>Vagrantfile</h3><table class="syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18</pre></div></td><td class="code"><div class="syntax"><pre><span class="c1"># -*- mode: ruby -*-</span><br /><span class="c1"># vi: set ft=ruby :</span><br /><br /><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span><br />  <span class="c1"># VM settings</span><br />  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;CentOS-6.4-x86_64-v20130309&quot;</span><br />  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&quot;http://developer.nrel.gov/downloads/vagrant-boxes/CentOS-6.4-x86_64-v20130309.box&quot;</span><br /><br />  <span class="c1"># Berkshelf settings</span><br />  <span class="n">config</span><span class="o">.</span><span class="n">berkshelf</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">true</span><br /><br />  <span class="c1"># chef-solo settings</span><br />  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:chef_solo</span> <span class="k">do</span> <span class="o">|</span><span class="n">chef</span><span class="o">|</span><br />    <span class="n">chef</span><span class="o">.</span><span class="n">run_list</span> <span class="o">=</span> <span class="o">[</span><br />      <span class="s2">&quot;recipe[nodejs::install_from_binary]&quot;</span><br />    <span class="o">]</span><br />  <span class="k">end</span><br /><span class="k">end</span><br /></pre></div></td></tr></table> <p>nodejs::install_from_binary でバイナリインストール。ただし redhat 系のしか無理なので、ubuntu 使う方は nodejs::install_from_package で。ソースからインストールもできる。</p><p>vagrant で使う box は Chef の入った CentOS 6.4 のミニマムなやつにしてみた。もちろん、既に add してる box がある人は、config.vm.box にその名前を入れてもいい。</p><p>ちなみに nrel は<a href="http://ja.wikipedia.org/wiki/%E5%9B%BD%E7%AB%8B%E5%86%8D%E7%94%9F%E5%8F%AF%E8%83%BD%E3%82%A8%E3%83%8D%E3%83%AB%E3%82%AE%E3%83%BC%E7%A0%94%E7%A9%B6%E6%89%80">国立再生可能エネルギー研究所</a>らしい。まぁさすがに信用できるだろうけど、そのうちちゃんと自分で box 作ろうと思う。</p><h3>Berksfile</h3><table class="syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>1<br />2<br />3</pre></div></td><td class="code"><div class="syntax"><pre><span class="n">site</span> <span class="ss">:opscode</span><br /><br /><span class="n">cookbook</span> <span class="s1">&#39;nodejs&#39;</span><br /></pre></div></td></tr></table> <p>opscode から <a href="http://community.opscode.com/cookbooks/nodejs">nodejs のクックブック</a>を取ってくる。</p><h2>vagrant up</h2><p>設定も書き終わったので、早速 vagrant up してみる。</p><table class="syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>1<br />2</pre></div></td><td class="code"><div class="syntax"><pre>cd myvagrant<br />vagrant up<br /></pre></div></td></tr></table> <p>最初は box のダウンロードに時間かかったりするけど、辛抱強く待つ。もしかしたら vagrant box add しといた方が楽かもしれない。</p><table class="syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>1<br />2<br />3<br />4</pre></div></td><td class="code"><div class="syntax"><pre>[Berkshelf] Updating Vagrant&#39;s berkshelf: &#39;C:/Users/~&#39;<br />[Berkshelf] Using nodejs (1.1.2)<br />[Berkshelf] Using build-essential (1.4.0)<br />[Berkshelf] Using apt (1.9.2)<br /></pre></div></td></tr></table> <p>こんな感じのログが出て、クックブックをどこからか取ってくる。nodejs に build-essential と apt が依存してるので、それも取ってきてくれる。</p><table class="syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>1<br />2<br />3<br />4<br />5<br />6<br />7</pre></div></td><td class="code"><div class="syntax"><pre>[default] Creating shared folders metadata...<br />[default] Clearing any previously set network interfaces...<br />[default] Preparing network interfaces based on configuration...<br />[default] Forwarding ports...<br />[default] -- 22 =&gt; 2222 (adapter 1)<br />[default] Booting VM...<br />[default] Waiting for VM to boot. This can take a few minutes.<br /></pre></div></td></tr></table> <p>ここまでで VM が立ち上がって、</p><table class="syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18<br />19<br />20<br />21</pre></div></td><td class="code"><div class="syntax"><pre>[default] Running provisioner: chef_solo...<br />Generating chef JSON and uploading...<br />Running chef-solo...<br />[2013-04-23T09:38:48+00:00] INFO: *** Chef 11.4.0 ***<br />[2013-04-23T09:38:49+00:00] INFO: Setting the run_list to [&quot;recipe[nodejs::install_from_binary]&quot;] from JSON<br />[2013-04-23T09:38:49+00:00] INFO: Run List is [recipe[nodejs::install_from_binary]]<br />[2013-04-23T09:38:49+00:00] INFO: Run List expands to [nodejs::install_from_binary]<br />[2013-04-23T09:38:49+00:00] INFO: Starting Chef Run for localhost<br />[2013-04-23T09:38:49+00:00] INFO: Running start handlers<br />[2013-04-23T09:38:49+00:00] INFO: Start handlers complete.<br />[2013-04-23T09:38:49+00:00] INFO: Processing remote_file[/usr/local/src/node-v0.10.2-linux-x64.tar.gz] action create_if_missing (nodejs::install_from_binary line 39)<br />[2013-04-23T09:39:07+00:00] INFO: remote_file[/usr/local/src/node-v0.10.2-linux-x64.tar.gz] updated<br />[2013-04-23T09:39:07+00:00] INFO: remote_file[/usr/local/src/node-v0.10.2-linux-x64.tar.gz] mode changed to 644<br />[2013-04-23T09:39:07+00:00] INFO: Processing ruby_block[verify_sha_sum] action run (nodejs::install_from_binary line 52)<br /><br />[2013-04-23T09:39:07+00:00] INFO: ruby_block[verify_sha_sum] called<br />[2013-04-23T09:39:07+00:00] INFO: Processing execute[install package to system] action run (nodejs::install_from_binary line 64)<br />[2013-04-23T09:39:08+00:00] INFO: execute[install package to system] ran successfully<br />[2013-04-23T09:39:08+00:00] INFO: Chef Run complete in 19.094028762 seconds<br />[2013-04-23T09:39:08+00:00] INFO: Running report handlers<br />[2013-04-23T09:39:08+00:00] INFO: Report handlers complete<br /></pre></div></td></tr></table> <p>一気に終了。vagrant ssh で VM に入って、確認。</p><table class="syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>1<br />2</pre></div></td><td class="code"><div class="syntax"><pre>$ node -v<br />v0.10.2<br /></pre></div></td></tr></table> <p>バッチリ入ってる！　ちょーテンション上がる！</p><h2>余談</h2><p>こんな短い設定ファイルで環境作れるとか、人間駄目になるなと思った。もっと駄目になっていきたい。</p><p>他にも rbenv + ruby_build を入れてみたり、vim を入れてみたりしたけども、どれも滞り無く実行された。</p><p>妄想だけど、こいつでガリガリ chef のテストをして、満足行く感じになったら vagrant の ec2 連携でインスタンス作れたら、もうちょっと人間駄目になれる気がする。</p><p>あ、私は<strong>まだ本番環境構築とかには使ってない</strong>ので、そこら辺はご了承願いたい。</p><p>あと opscode の cookbook はいろんな OS に対応するために冗長なので、素直に cookbook を書いたほうがいい場合も多い。ということで、Chef 知らなくてもここまではできるけど、ここから先のカスタマイズには Chef の知識が必要になる。</p><p>ということで、これから頑張ります（</p>