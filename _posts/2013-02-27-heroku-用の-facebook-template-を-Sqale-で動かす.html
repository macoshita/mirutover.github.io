---
layout: post
title: heroku 用の facebook template を Sqale で動かす
date: 2013-02-27 14:16:58 UTC
updated: 2013-02-27 14:16:58 UTC
comments: false
categories: Facebook Sqale Ruby
---

<p>facebook の dev center から facebook アプリを作るとき、heroku にサンプルアプリをデプロイするかどうか選べる。出た当初は「すげぇ！　あと書き換えて push するだけじゃん！」って思ったもんだ。でも、正直 heroku は日本国内から使うにはちょっとだるいというのが自分の印象で、通信が重いからデプロイするのもログ見るのも遅くてグンニョリする。</p> <p>ところが最近は、先日のブログでも書いたけれど Sqale だったり mogok だったり ruby 系の国産 PaaS が増えてきてて、結構いい感じに動いてくれる。 と、<a href="https://sqale.jp/support">Sqale のサポートページ</a>を見てたら <a href="http://ddollar.github.com/foreman/">FOREMAN</a> に対応してたり postinstall が使えるようになってたりしてて、heroku でデプロイしてるやつを移行するのも簡単そうだなと思い、試しに facebook テンプレートアプリを動かしてみた。</p> <h2>Sqale と facebook の準備</h2> <h3>Sqale</h3> <p><a href="https://sqale.jp/dashboard">sqale のダッシュボード</a> から新しいアプリを作る。仮に <strong>fb-test</strong> で取ったとして話を進める。あと公開鍵の設定は終わってる前提で。前のブログにも書いたけど、１アプリに付き１５日無料なので、躊躇わずアカウントとって遠慮せず作るべし。</p> <p>数十秒でアプリが出来上がり、リロードすると下記の画面が表示される。</p> <p><a href="http://2.bp.blogspot.com/-502NmPYtZq4/US4SO7ufXpI/AAAAAAAAA6c/aBDTIL3oh80/s320/5b7c6597-a815-4bb5-9c5f-c552044472b0.jpeg"><img src="http://2.bp.blogspot.com/-502NmPYtZq4/US4SO7ufXpI/AAAAAAAAA6c/aBDTIL3oh80/s320/5b7c6597-a815-4bb5-9c5f-c552044472b0.jpeg" alt="Sqale Dashboard" /></a></p> <h3>facebook</h3> <p><a href="https://developers.facebook.com/apps">https://developers.facebook.com/apps</a> からアプリを作る。適当な名前とネームスペースを入れて決定するだけ。</p> <p>作成後、「App Domains」と「Facebook でログインするサイト」を Sqale で作ったアプリの URL を指定してやる。</p> <p><a href="http://4.bp.blogspot.com/-DURf1R4JkGE/US4TbL3HKwI/AAAAAAAAA6o/FKBtvvk9xsY/s320/44f3c05c-7013-4de8-98cc-29ea50a61f9a.jpeg"><img src="http://4.bp.blogspot.com/-DURf1R4JkGE/US4TbL3HKwI/AAAAAAAAA6o/FKBtvvk9xsY/s320/44f3c05c-7013-4de8-98cc-29ea50a61f9a.jpeg" alt="facebook apps" /></a></p> <p>ここの、App ID と App Secret は後で必要になる。</p> <h2>heroku テンプレートアプリの clone &amp; git リポジトリ追加</h2> <p><a href="https://github.com/heroku/facebook-template-ruby">heroku の facebook テンプレートアプリ</a>は github にあるので、clone してくる。</p> <pre><code>git clone git://github.com/heroku/facebook-template-ruby.git<br /></code></pre> <p>次に Sqale の git リポジトリをコピーして、先程 clone したディレクトリに移動しリポジトリを追加する。</p> <pre><code>cd facebook-template-ruby<br />git remote add sqale ssh://sqale@gateway.sqale.jp:2222/mirutover/fb-test.git<br /></code></pre> <h2>clone したアプリを Sqale 用に編集</h2> <h3>.env と postinstall</h3> <p>Facebook のキーを入れるため、.env ファイルを作り、下記のように記述する。</p> <pre><code>FACEBOOK_APP_ID={さっきの App ID}<br />FACEBOOK_SECRET={さっきの App Secret}<br /></code></pre> <p>これを commit して push するのはどうよって話なので、.gitignore にすでに書かれている。なので、<a href="https://sqale.jp/support/manual/faq-technical#secret-env">こちらのページ</a>にある通り、postinstall を用意する。下記のように記述。shebang 必須。</p> <pre><code>#!/bin/sh<br /><br />cp /home/sqale/etc/.env /home/sqale/current/<br /></code></pre> <h3>Procfile</h3> <p>FOREMAN 用の設定ファイル Procfile をいじる。heroku だと web: 〜 とかなってるのを、<a href="https://sqale.jp/support/manual/change-web-server">こちら</a> の thin 用の設定ファイルに書き換える。</p> <pre><code>app: bundle exec thin --socket /var/run/app/app.sock start<br /></code></pre> <h3>app.rb</h3> <p>この項目は後々消すかもしれない。テンプレートアプリ、動かないんだ。多分バグだと思う。app.rb を下記のように書き換えてやれば動く。</p> <pre><code>--- a/app.rb<br />+++ b/app.rb<br />@@ -48,7 +48,7 @@ helpers do<br /><br />   # allow for javascript authentication<br />   def access_token_from_cookie<br />-    authenticator.get_user_info_from_cookies(request.cookies)['access_token']<br />+    @access_token ||= authenticator.get_user_info_from_cookies(request.cookies)['access_token']<br />   rescue =&gt; err<br />     warn err.message<br />   end<br /></code></pre> <p>原因は facebook SDK の koala の<a href="https://github.com/arsduo/koala/pull/268">この pull request</a> を読む限り、fb の仕様変更→ koala の get_user_info_from_cookies メソッドが仕様変更→テンプレートアプリが対応してない　……だと思う。pullreq 投げるかなー。</p> <h3>commit</h3> <p>全部編集したら git add . して git commit -a</p> <h2>Sqale にデプロイする</h2> <h3>.env を配置</h3> <p>まず SSH して .env を置いておく。SSH は Sqale のダッシュボードにコマンドが書かれてるので、それをコピペでいけるはず。</p> <pre><code>ssh -p 2222 sqale@gateway.sqale.jp<br /></code></pre> <p>SSH できたらホームディレクトリに etc ディレクトリを作って .env をコピー</p> <pre><code>mkdir etc<br />vi etc/.env<br />logout<br /></code></pre> <h3>ソースコードをデプロイ</h3> <p>最後に、ログアウトして、下記コマンドでデプロイするのみ。</p> <pre><code>$ git push sqale master<br />Counting objects: 174, done.<br />Delta compression using up to 4 threads.<br />Compressing objects: 100% (78/78), done.<br />Writing objects: 100% (174/174), 127.35 KiB, done.<br />Total 174 (delta 79), reused 167 (delta 77)<br />To ssh://sqale@gateway.sqale.jp:2222/mirutover/fb-test.git<br /> * [new branch]      master -&gt; master<br /></code></pre> <h2>起動確認</h2> <p>うまく動いていれば、facebook でログインするページが表示されて、ログインするとあなたの顔写真やら名前やら友達リストやらが表示されるはず。</p> <p>うまく動かないなら、SSH 接続して /var/log/app のログを確認したり ps コマンドで foreman プロセスがちゃんと動いてるか確認したりしてなんとかしよう！</p> <h2>まとめ</h2> <p>もっと軽く書くつもりが割と力が入っている気がした今日この頃。</p>