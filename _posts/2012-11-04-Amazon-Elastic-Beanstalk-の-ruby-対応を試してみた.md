---
layout: post
title: Amazon Elastic Beanstalk の ruby 対応を試してみた
date: 2012-11-04 07:20:00 UTC
updated: 2012-11-04 07:48:52 UTC
comments: false
categories: blog
tags: Amazon Elastic Beanstalk Mac Ruby
---
{% include JB/setup %}

<br />Mashup Award 8 の作品を作っていたら、ちょうどタイミングよく Amazon Elastic Beanstalk が Ruby 対応を始めたので、こりゃ勉強がてらちょうどいいやということでやってみました。<br /><br /><b><u>Elastic Beanstalk (以下EBT) とは？</u></b><br />一言でいえば PaaS です。<br />heroku や dotcloud や google appengine が近いですね。<br />ロードバランサー１つと micro instance １つで動かす分には無料枠に収まります。<br />サービスが成長したら、micro を medium や large にしたり、インスタンス増やしたりもできます。<br />また Amazon RDS や S3 などの AWS の別サービスを普通に利用できる（別料金）ので、幅広いアプリケーションに対応できます。<br /><br /><b><u>heroku とかと何が違うの？</u></b><br />少なくとも私が触ったことのある既存PaaSと比較すると、かなりスケルトンな感じです。<br />サンプルをえいやっと立てると、<b>ELBが立ち上がり、EC2が立ち上がり、S3にバケットが作られますが、</b>これらが<b>AWSのマネジメント・コンソールに全部ちゃんと出てきます</b>。普通にSSHもできますし、使わないときは停止もできます。<br />AWSの管理コンソールに慣れた人にとってはとても魅力的ですし、もし「EBTで管理するのやめよう」とかなっても環境そのままでどうにかできそうです。あと、サンプルで立てられたサーバを覗くと色々と勉強にもなります。<br /><br /><b><u>参考になるリンク</u></b><br />公式には rails と sinatra のデプロイ方法が乗っていますが、どちらも軽く目を通すと勉強になってよいです。<br />お急ぎの方は下記の sinatra の方をどうぞ。<br /><br />Deploying a Sinatra Application to AWS Elastic Beanstalk<br /><a href="http://docs.amazonwebservices.com/elasticbeanstalk/latest/dg/create_deploy_Ruby_sinatra.html">http://docs.amazonwebservices.com/elasticbeanstalk/latest/dg/create_deploy_Ruby_sinatra.html</a><br /><br /><b>こちらのページはあくまで私のメモ書きというスタンスになっています。</b>きちんとした情報は公式から仕入れてください。<br /><br />なぜだか、AWSのドキュメントは斜め読みがし難い感じがします。<br /><div><br /></div><br /><b><u>実際の作業</u></b><br /><b>command line tools をダウンロードして導入します。</b><br />マネジメントコンソールからやればいいのでは？と思うかもしれませんが、自分はコマンドラインのほうが楽でした。<br /><a href="http://aws.amazon.com/code/6752709412171743">http://aws.amazon.com/code/6752709412171743</a><br />Running the Sample はとりあえず無視し、sinatraのサンプルのデプロイをやってみます。<br /><br /><b>まず適当にプロジェクト用のディレクトリを作成し、git init</b><br />mkdir ebt_sample<br />cd ebt_sample<br />git init .<br /><br /><b>次に、先程導入したebを実行します。</b><br />eb init<br /><br /><b>ここで、AWS の AccessKey と SecretKey を聞かれるので、答えます。</b><br />Enter your AWS Access Key ID (current value is ""):<br />Enter your AWS Secret Access Key (current value is ""):<br /><br /><b>Tokyo を選びましょう</b><br />Available service regions are:<br />1) US East (Virginia)<br />...<br />6) Asia Pacific (Tokyo)<br />Select: &nbsp;(1 to 6):<br /><br /><b>アプリケーション名を聞かれるので、好きな名前を入れてください。環境名も変えたければ変更。</b><br />Enter an AWS Elastic Beanstalk application name (auto-generated value is ""):<br />Enter an AWS Elastic Beanstalk environment name (current value is ""):<br /><br /><b>Ruby を選びましょう。</b><br />64bit で困ることはあまりない気がします。それにしてもいろいろありますね。<br />elect a solution stack (current value is "64bit Amazon Linux running Ruby 1.9.3").<br />Available solution stacks are:<br />1) 32bit Amazon Linux running PHP 5.3<br />...<br />13) 64bit Amazon Linux running Ruby 1.9.3<br />Select: &nbsp;(1 to 13):<br /><br /><b>RDS をここで作ることができます。</b><br />やったことないですが、上記の通りEBTは作ったあとに中身が丸見えなので、あとからでもどうとでもなります。<br />Create an RDS DB Instance? [y/n] (current value is "No"): n<br /><br />ここまでの手順を終えても、まだ実際の環境が作られるわけではありません。<br /><b>次のコマンドを打って環境を作成しましょう。</b><br />eb start<br /><br />以上で、サンプルプログラムが動作します。<br /><b>下記で動作確認し、Green になったらURLにアクセスしましょう</b><br />eb status<br /><br />ここまでで十分簡単だと感じてもらえたと思いますが、自分のsinatraアプリケーションを動かすのは更に簡単です。<br /><b>下記３つのファイルを用意してください。</b><br /><br /><b># config.ru</b><br />require "./helloworld"<br />run Sinatra::Application<br /><br /><b># helloworld.rb</b><br />require "sinatra"<br />get "/" do<br />&nbsp; "hello, world"<br />end<br /><br /><b># Gemfile</b><br />source :rubygems<br />gem "sinatra"<br /><br /><b>あとは、git でコミット→プッシュの流れです</b><br />git commit -a<br />git aws.push<br /><br />また eb status で動作を確認し、Green になったらURLにアクセスすれば、世界に「こんにちは」ができるはずです。<br /><br /><b><u>独自ドメイン</u></b><br />CNAMEで振っても良いと思いますが、せっかくなのでRoute 53を使ってみました。<br />（自分の用途だと月額１ドルもしないはずなので）<br />value-domain でドメインを取得し、ネームサーバを切り替えました。下記を参考にさせて頂きました。お名前.comとかでも似たようなことをやればいけるはずです。<br /><a href="http://www.dondari.com/index.php/%E3%81%AF%E3%81%98%E3%82%81%E3%81%A6%E3%81%AERoute_53">http://www.dondari.com/index.php/%E3%81%AF%E3%81%98%E3%82%81%E3%81%A6%E3%81%AERoute_53</a><br />そしてRoute 53側の設定ですが、EBTに作られたELBをALIASで指定したAレコードを追加するだけでOKです。<br />Route 53は、ELBに独自ドメインを簡単に割り振ることができるので、結果としてEBTもその恩恵を受けることができます。<br /><br /><b><u>デプロイスクリプト設定</u></b><br />デプロイと同時に起動するスクリプトを書くことができます。<br /><a href="http://docs.amazonwebservices.com/elasticbeanstalk/latest/dg/customize-containers.html">http://docs.amazonwebservices.com/elasticbeanstalk/latest/dg/customize-containers.html</a><br />簡単に言うと、プロジェクトのトップに .ebextensions というディレクトリを作り、.configという拡張子のファイルを突っ込むとファイル名のアルファベット順に実行してくれます。<br /><br />.ebextensions/<br />&nbsp; - hoge.config<br /><br />ユーザ作成や yum などのソフト管理ができるので、知っておく必要があります。<br />私はcronを書く必要があったので使いました。<br />下記は CloudWatch のカスタム参考にもなります。<br /><a href="http://docs.amazonwebservices.com/elasticbeanstalk/latest/dg/customize-containers-cw.html">http://docs.amazonwebservices.com/elasticbeanstalk/latest/dg/customize-containers-cw.html</a><br /><br /><b><u>マネジメントコンソールの使い所</u></b><br />個人的にはEventsとVersionsのタブは割と使えるなとおもいます。<br />Versions に関しては、以前のバージョンに戻したり、削除したりできます。<br />バージョンを貯めたままにしておくとS3代が多少かかりますので、不要なバージョンは削除したほうがよいでしょう。<br /><br /><b><u>まとめ</u></b><br />自分用メモ書きにちょっと付け加えた感じで全力ですっとばしましたが、こうしてできたのが下記の、2D美少女とリアル美少女のどちらが可愛いから投票するという、ちょっと頭がおかしかったんだろうなとしか思えないサービスです。<br /><br /><br /><h1 style="background-color: white; color: #333333; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 72px; line-height: 40px; margin: 10px 0px; text-align: center; text-rendering: optimizelegibility;"><span style="color: red;">2D</span>&nbsp;vs&nbsp;<span style="color: blue;">3D</span></h1><h4 style="background-color: white; color: #333333; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 17.5px; line-height: 20px; margin: 10px 0px; text-align: center; text-rendering: optimizelegibility;">- 次元を超えた戦い -</h4><br /><div style="text-align: center;"><a href="http://2d-vs-3d.net/">http://2d-vs-3d.net</a></div><br />サービスを思いついたのが締め切り当日で、３〜４時間で完成させなければいけないという縛りがあったため、MA8提出まではmicroインスタンス一台立てて、その中で開発してそのままデプロイするという<strike style="font-weight: bold;"><span style="font-size: x-small;">アレな手法</span></strike><b>CI</b>を行いましたが、それを改めてElastic Beanstalkに置き換えた形となります。<br />一応「既存サービスのEBT置き換えの実績」と言えるかもしれませんｗ<br /><br /><b><u>余談</u></b><br /><b>heroku やばいんちゃうのん？</b><br />と、チラッと思ったのですが、heroku の魅力はあの至れり尽くせりな add-on にあると思うので、EBT がその域に達するにはまだかなりの時間がかかると思われます。そもそも達するつもりなのかも分からないところですし。あと、heroku の方が売り方が上手な感じです。